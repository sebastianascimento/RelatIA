{% extends 'analyzer/base.html' %}

{% block title %}Analysis Report - RelatIA{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0 text-gray-800">Analysis Report</h1>
    <a href="{% url 'upload' %}" class="btn btn-primary">
        <i class="bi bi-upload"></i> Upload Another File
    </a>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-file-earmark-code"></i> 
            File: {{ file.filename }}
        </div>
        <span class="badge 
            {% if report.status == 'completed' %}bg-success
            {% elif report.status == 'processing' %}bg-warning
            {% elif report.status == 'failed' %}bg-danger
            {% else %}bg-secondary{% endif %}">
            {{ report.status|title }}
        </span>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <h5 class="card-title">File Information</h5>
            <dl class="row">
                <dt class="col-sm-3">Uploaded</dt>
                <dd class="col-sm-9">{{ file.uploaded_at }}</dd>
                
                <dt class="col-sm-3">Size</dt>
                <dd class="col-sm-9">{{ file.file_size|filesizeformat }}</dd>
                
                <dt class="col-sm-3">Type</dt>
                <dd class="col-sm-9">{{ file.content_type }}</dd>
            </dl>
        </div>
        
        {% if report.status == 'processing' %}
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Analysis in progress...</p>
                <p class="text-muted small">This may take a few minutes. The page will refresh automatically.</p>
            </div>
        {% elif report.status == 'failed' %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Analysis failed. Please try again.
            </div>
            <div class="mt-3">
                <p>{{ report.summary }}</p>
            </div>
        {% else %}
            <div class="mb-4">
                <h5 class="card-title">Summary</h5>
                <div class="p-3 bg-light rounded">
                    {{ report.summary|linebreaks }}
                </div>
            </div>
            
            <h5 class="card-title">Detailed Analysis</h5>
            <div class="accordion" id="analysisAccordion">
                {% for analysis in analyses %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <button class="accordion-button {% if forloop.counter > 1 %}collapsed{% endif %}" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ forloop.counter }}" 
                                    aria-expanded="{% if forloop.counter == 1 %}true{% else %}false{% endif %}" 
                                    aria-controls="collapse{{ forloop.counter }}">
                                {% if analysis.agent == 'structure' %}
                                    <i class="bi bi-diagram-3 me-2 text-primary"></i> Structure Analysis
                                {% elif analysis.agent == 'security' %}
                                    <i class="bi bi-shield-check me-2 text-success"></i> Security Analysis
                                {% elif analysis.agent == 'quality' %}
                                    <i class="bi bi-star me-2 text-warning"></i> Quality Analysis
                                {% else %}
                                    <i class="bi bi-question-circle me-2 text-secondary"></i> {{ analysis.agent|title }} Analysis
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ forloop.counter }}" 
                             class="accordion-collapse collapse {% if forloop.counter == 1 %}show{% endif %}" 
                             aria-labelledby="heading{{ forloop.counter }}" 
                             data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                <pre class="analysis-text">{{ analysis.result }}</pre>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="alert alert-info">
                        No analysis results available yet.
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if report.status == 'processing' %}
<script>
    // Auto-refresh the page every 5 seconds if the report is still processing
    setTimeout(function() {
        location.reload();
    }, 5000);
</script>
{% endif %}
<style>
    .analysis-text {
        white-space: pre-wrap;
        font-family: inherit;
        font-size: 1rem;
        color: #212529;
        background-color: transparent;
        border: none;
        padding: 0;
        margin-bottom: 0;
        overflow: visible;
    }
    
    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #212529;
    }
</style>
{% endblock %}